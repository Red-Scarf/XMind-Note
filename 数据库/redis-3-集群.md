# redis 再进阶
# 主从复制
主从复制可以在一定程度上扩展 redis 性能, redis 的主从复制和关系型数据库的主从复制类似, 从机能够精确的复制主机上的内容。实现了主从复制之后, 一方面能够实现数据的读写分离, 降低 master 的压力, 另一方面也能实现数据的备份。
## 配置
有多个 redis 实例时, 在从机输入命令 `slaveof 主机ip 主机端口` 即可配置主机, 或者在配置文件 redis.conf 中配置 `slaveof 主机ip 主机端口` 也行。

主机和从机均可通过 `INFO replication` 命令获取主从机器的信息。

## 主从复制注意点
1. 如果主机已经运行了一段时间了, 并且了已经存储了一些数据了, 此时从机连上来, 那么从机会将主机上所有的数据进行备份, 而不是从连接的那个时间点开始备份。
2. 配置了主从复制之后, 主机上可读可写, 但是从机只能读取不能写入(可以通过修改redis.conf中 slave-read-only 的值让从机也可以执行写操作)。
3. 在整个主从结构运行过程中, 如果主机不幸挂掉, 重启之后, 他依然是主机, 主从复制操作也能够继续进行。

## 原理
1. slave 启动成功连接到 master 后会发送一个 sync 命令。
2. Master 接到命令启动后台的存盘进程, 同时收集所有接收到的用于修改数据集命令。
3. 在后台进程执行完毕之后, master 将传送整个数据文件到 slave, 以完成一次完全同步。
4. 全量复制：而 slave 服务在接收到数据库文件数据后, 将其存盘并加载到内存中。
5. 增量复制：Master 继续将新的所有收集到的修改命令依次传给 slave, 完成同步。
6. 但是只要是重新连接 master, 一次完全同步(全量复制)将被自动执行。

## 接力
主从模式也可以使用链式传递, A 作为 B 的主机, B 又作为 C 的主机。

## 哨兵模式
如果在主机宕机时, 能够从从机中选出一个来充当主机, 就是哨兵模式。

配置哨兵模式, 需要在 redis 的安装目录下, 打开 sentinel.conf 文件作配置。
```
sentinel monitor mymaster 127.0.0.1 6379 1
```
mymaster 是给要监控的主机取的名字, 后面是主机地址, 最后面的2表示有多少个sentinel认为主机挂掉了, 就进行切换。

输入命令启动哨兵
```
redis-sentinel sentinel.conf
```

当主机宕机后, redis 内部会进行推举, 选出一个新的主机, 之后如果前主机重启, 也没办法成为主机, 只能做一个从机。

# 集群
由于所有的写操作都是先在 Master 上操作, 然后同步更新到 Slave上, 所以从 Master 同步到 Slave 机器有一定的延迟, 当系统很繁忙的时候, 延迟问题会更加严重, Slave 机器数量的增加也会使这个问题更加严重。因此还需要集群来进一步提升 redis 性能。

## 原理
1. 所有的 Redis 节点彼此互联(PING-PONG 机制),内部使用二进制协议优化传输速度和带宽
2. 节点的 fail 是通过集群中超过半数的节点检测失效时才生效
3. 客户端与 Redis 节点直连,不需要中间 proxy 层, 客户端不需要连接集群所有节点, 连接集群中任何一个可用节点即可
4. Redis-cluster 把所有的物理节点映射到 [0-16383]slot上, cluster (簇)负责维护`node<->slot<->value`。Redis 集群中内置了16384个哈希槽, 当需要在 Redis 集群中放置一个 key-value 时, Redis 先对 key 使用 crc16 算法算出一个结果, 然后把结果对 16384 求余数, 这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽, Redis  会根据节点数量大致均等的将哈希槽映射到不同的节点

## 判定节点不可用
投票过程是集群中所有 master 参与, 如果半数以上 master 节点与 master 节点通信超过`cluster-node-timeout`设置的时间, 认为当前 master 节点挂掉。

1. 如果集群任意 master 挂掉,且当前 master 没有 slave. 集群进入 fail 状态,也可以理解成集群的 slot 映射 [0-16383] 不完整时进入 fail 状态。
2. 如果集群超过半数以上 master 挂掉, 无论是否有 slave, 集群进入 fail 状态, 当集群不可用时, 所有对集群的操作做都不可用, 收到((error) CLUSTERDOWN The cluster is down)错误。